<script>
const JSON_LINK = "/user.json"; // URL returning { masterPIN: "...", users: [...] }

const LOGIN_STORAGE_KEY = "authData";
const PIN_STORAGE_KEY = "authPinData";

const pinExpiryDays = 30;

function saveAuthData(name, pin, id) {
  const now = new Date();
  const pinData = {
    pin,
    timestamp: now.getTime()
  };
  localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify({ name, id }));
  localStorage.setItem(PIN_STORAGE_KEY, JSON.stringify(pinData));
}

function loadAuthData() {
  const auth = localStorage.getItem(LOGIN_STORAGE_KEY);
  const pinData = localStorage.getItem(PIN_STORAGE_KEY);
  const now = new Date();
  const loginPath = "/entry/";

  if (!auth || !pinData) {
    if (window.location.pathname !== loginPath) {
      window.location.href = loginPath;
    }
    return null;
  }

  const authObj = JSON.parse(auth);
  const pinObj = JSON.parse(pinData);
  const savedID = authObj?.id;

  if (now.getTime() - pinObj.timestamp > pinExpiryDays * 24 * 60 * 60 * 1000) {
    localStorage.removeItem(LOGIN_STORAGE_KEY);
    localStorage.removeItem(PIN_STORAGE_KEY);
    if (window.location.pathname !== loginPath) {
      window.location.href = loginPath;
    }
    return null;
  }

  return { name: authObj.name, pin: pinObj.pin, id: savedID };
}


async function fetchAuthData() {
  try {
    const res = await fetch(JSON_LINK);
    if (!res.ok) throw new Error("Failed to fetch auth data.");
    return await res.json(); // expecting { masterPIN: "...", users: [{ AuthName, ID }, ...] }
  } catch (e) {
    console.error(e);
    return null;
  }
}

async function authenticate() {
  const nameInput = document.getElementById("authName").value.trim();
  const idInput = document.getElementById("authID").value.trim();
  const pinInput = document.getElementById("authPIN").value.trim();

  const authData = await fetchAuthData();
  if (!authData) {
    alert("Unable to fetch authentication data.");
    return false;
  }

  if (pinInput !== authData.masterPIN) {
    alert("Incorrect PIN.");
    return false;
  }

  const isAuthorized = authData.users.some(
    item => item.AuthName.toLowerCase() === nameInput.toLowerCase() &&
            item.ID.toLowerCase() === idInput.toLowerCase()
  );

  if (!isAuthorized) {
    alert("Name and ID not authorized.");
    return false;
  }

  saveAuthData(nameInput, pinInput, idInput);
  personalizeWelcome(nameInput);

  // Redirect after successful login
  window.location.href = "/"; // Replace with your landing/target page

  return true;
}

window.addEventListener("DOMContentLoaded", () => {
  const auth = loadAuthData();
  const loginPath = "/entry/";
  const homePath = "/"; // or your target logged-in landing page

  if (auth) {
    // If authenticated and currently on login page, redirect to homepage
    if (window.location.pathname === loginPath) {
      window.location.href = homePath;
      return;
    }
    // Else personalize welcome on authenticated pages
    personalizeWelcome(auth.name);
  } else {
    // If not authenticated and not on login page, redirect to login
    if (window.location.pathname !== loginPath) {
      window.location.href = loginPath;
    }
  }
});

document.getElementById("loginBtn").addEventListener("click", authenticate);

function personalizeWelcome(name) {
  const nameDiv = document.querySelectorAll(".AuthName");
  if (nameDiv) {
    nameDiv.textContent = name;
  }

  // Optionally hide login inputs if on login page and logged in (should redirect away though)
  const loginContainer = document.getElementById("login-container");
  if (loginContainer) loginContainer.style.display = "none";
}

window.addEventListener("DOMContentLoaded", async () => {
  const storedAuth = loadAuthData();
  if (!storedAuth) return; // already handled or not logged in

  try {
    const response = await fetch("/user.json");
    if (!response.ok) throw new Error("Failed to fetch user.json");
    const authData = await response.json();

    const matchedUser = authData.users.find(
      user => user.AuthName.toLowerCase() === storedAuth.name.toLowerCase()
    );

    if (!matchedUser || storedAuth.pin !== authData.masterPIN) {
      localStorage.removeItem(LOGIN_STORAGE_KEY);
      localStorage.removeItem(PIN_STORAGE_KEY);
      if (window.location.pathname !== "/entry/") {
        window.location.href = "/entry/";
      }
    }
  } catch (error) {
    console.error("Error verifying auth data with user.json", error);
  }
});
</script>
