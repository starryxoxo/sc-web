<script>
// authVerification.js
const JSON_LIST = "/ghk.json"; // Path to your user JSON
const LOGIN_STORAGE_K = "authData";
const PIN_STORAGE_K = "authPinData";

// Clear existing interval if any (helps avoid duplicates on reload)
if (window.authVerificationInterval) {
  clearInterval(window.authVerificationInterval);
}

console.log("Starting periodic auth verification every 2 seconds");

window.authVerificationInterval = setInterval(async () => {
  console.log("Periodic auth check triggered");

  const storedAuth = (function () {
    const auth = localStorage.getItem(LOGIN_STORAGE_K);
    const pinData = localStorage.getItem(PIN_STORAGE_K);
    if (!auth || !pinData) return null;
    const authObj = JSON.parse(auth);
    const pinObj = JSON.parse(pinData);
    console.log("Loaded from localStorage:", authObj, pinObj);
    return { name: authObj.name, id: authObj.id, pin: pinObj.pin };
  })();

  if (!storedAuth) {
    console.warn("No storedAuth found, clearing interval");
    clearInterval(window.authVerificationInterval);
    return;
  }

  try {
    const response = await fetch(JSON_LIST, { cache: "no-store" }); // Disable cache
    if (!response.ok) throw new Error("Failed to fetch auth");
    const authData = await response.json();

    console.log("Fetched authData:", authData);

    const matchedUser = authData.users.find(
      (user) =>
        user.AuthName.toLowerCase() === storedAuth.name.toLowerCase() &&
        user.ID.toLowerCase() === (storedAuth.id || "").toLowerCase()
    );

    if (!matchedUser) {
      console.warn(
        `User not found: Name=${storedAuth.name}, ID=${storedAuth.id}`
      );
    }
    if (storedAuth.pin !== authData.masterPIN) {
      console.warn(
        `PIN mismatch: Stored PIN=${storedAuth.pin}, Master PIN=${authData.masterPIN}`
      );
    }
    if (!matchedUser || storedAuth.pin !== authData.masterPIN) {
      console.info("Invalid auth data, clearing storage and redirecting");
      localStorage.removeItem(LOGIN_STORAGE_K);
      localStorage.removeItem(PIN_STORAGE_K);
      clearInterval(window.authVerificationInterval);
      if (window.location.pathname !== "/entry/") {
        window.location.href = "/entry/";
      }
    }
  } catch (error) {
    console.error("Error during periodic auth verification:", error);
  }
}, 2000);
</script>
